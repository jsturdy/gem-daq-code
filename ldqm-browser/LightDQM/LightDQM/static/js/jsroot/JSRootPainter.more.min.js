(function(a){if(typeof define==="function"&&define.amd){define(["d3","JSRootPainter"],a)}else{if(typeof d3!="object"){throw new Error("This extension requires d3.v3.js","JSRootPainter.more.js")}if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootPainter.more.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter not defined","JSRootPainter.more.js")}a(d3,JSROOT)}}(function(b,a){a.Painter.CreateDefaultPalette=function(){function l(v,u,y){var i,w,x;if(y<1e-300){i=w=x=u}else{function t(z,s,r){if(r<0){r+=1}if(r>1){r-=1}if(r<1/6){return z+(s-z)*6*r}if(r<1/2){return s}if(r<2/3){return z+(s-z)*(2/3-r)*6}return z}var n=u<0.5?u*(1+y):u+y-u*y;var o=2*u-n;i=t(o,n,v+1/3);w=t(o,n,v);x=t(o,n,v-1/3)}return"rgb("+Math.round(i*255)+","+Math.round(w*255)+","+Math.round(x*255)+")"}var d=[];var g=1,m=0.5,e=280,c=0,k=50;for(var f=0;f<k;++f){var h=(e-(f+1)*((e-c)/k))/360;var j=l(h,m,g);d.push(j)}return d};a.Painter.CreateGradientColorTable=function(o,k,d,e,m,j){var i=[];for(var l=1;l<o.length;l++){var h=parseInt(Math.floor(m*o[l])-Math.floor(m*o[l-1]));for(var n=0;n<h;n++){var f=Math.round(k[l-1]+n*(k[l]-k[l-1])/h)+","+Math.round(d[l-1]+n*(d[l]-d[l-1])/h)+","+Math.round(e[l-1]+n*(e[l]-e[l-1])/h);i.push("rgb("+f+")")}}return i};a.Painter.GetColorPalette=function(d,h){if((d==null)||(d==0)){d=a.gStyle.Palette}var e=[0,0.125,0.25,0.375,0.5,0.625,0.75,0.875,1];var g,f,c;switch(d){case 51:var g=[0,9,13,17,24,32,27,25,29];var f=[0,0,0,2,37,74,113,160,221];var c=[28,42,59,78,98,129,154,184,221];break;case 52:g=[0,32,64,96,128,160,192,224,255];f=[0,32,64,96,128,160,192,224,255];c=[0,32,64,96,128,160,192,224,255];break;case 53:g=[0,45,99,156,212,230,237,234,242];f=[0,0,0,45,101,168,238,238,243];c=[0,1,1,3,9,8,11,95,230];break;case 54:g=[0,22,44,68,93,124,160,192,237];f=[0,16,41,67,93,125,162,194,241];c=[97,100,99,99,93,68,44,26,74];break;case 55:g=[0,5,15,35,102,196,208,199,110];f=[0,48,124,192,206,226,97,16,0];c=[99,142,198,201,90,22,13,8,2];break;case 56:g=[242,234,237,230,212,156,99,45,0];f=[243,238,238,168,101,45,0,0,0];c=[230,95,11,8,9,3,1,1,0];break;case 57:g=[0.2082*255,0.0592*255,0.078*255,0.0232*255,0.1802*255,0.5301*255,0.8186*255,0.9956*255,0.9764*255];f=[0.1664*255,0.3599*255,0.5041*255,0.6419*255,0.7178*255,0.7492*255,0.7328*255,0.7862*255,0.9832*255];c=[0.5293*255,0.8684*255,0.8385*255,0.7914*255,0.6425*255,0.4662*255,0.3499*255,0.1968*255,0.0539*255];break;case 58:g=[0,0.0956*255,0.0098*255,0.2124*255,0.6905*255,0.9242*255,0.7914*255,0.7596*255,1*255];f=[0,0.1147*255,0.3616*255,0.5041*255,0.4577*255,0.4691*255,0.6905*255,0.9237*255,1*255];c=[0,0.2669*255,0.3121*255,0.1318*255,0.2236*255,0.6741*255,0.9882*255,0.9593*255,1*255];break;case 59:g=[13,23,25,63,76,104,137,161,206];f=[95,67,37,21,0,12,35,52,79];c=[4,3,2,6,11,22,49,98,208];break;case 60:g=[0,61,89,122,143,160,185,204,231];f=[0,0,0,0,14,37,72,132,235];c=[0,140,224,144,4,5,6,9,13];break;case 61:g=[14,7,2,0,5,11,55,131,229];f=[105,56,26,1,42,74,131,171,229];c=[2,21,35,60,92,113,160,185,229];break;case 62:g=[0,0,0,70,148,231,235,237,244];f=[0,0,0,0,0,69,67,216,244];c=[0,102,228,231,177,124,137,20,244];break;case 63:g=[50,56,63,68,93,121,165,192,241];f=[66,81,91,96,111,128,155,189,241];c=[97,91,75,65,77,103,143,167,217];break;case 64:g=[145,166,167,156,131,114,101,112,132];f=[158,178,179,181,163,154,144,152,159];c=[190,199,201,192,176,169,160,166,190];break;case 65:g=[93,91,99,108,130,125,132,155,174];f=[126,124,128,129,131,121,119,153,173];c=[103,94,87,85,80,85,107,120,146];break;case 66:g=[24,40,69,90,104,114,120,132,103];f=[29,52,94,127,150,162,159,151,101];c=[29,52,96,132,162,181,184,186,131];break;case 67:g=[46,38,61,92,113,121,132,150,191];f=[46,36,40,69,110,135,131,92,34];c=[46,80,74,70,81,105,165,211,225];break;case 68:g=[0,4,12,30,52,101,142,190,237];f=[0,40,86,121,140,172,187,213,240];c=[0,9,14,18,21,23,27,35,101];break;case 69:g=[198,206,206,211,198,181,161,171,244];f=[103,133,150,172,178,174,163,175,244];c=[49,54,55,66,91,130,184,224,244];break;case 70:g=[243,243,240,240,241,239,186,151,129];f=[0,46,99,149,194,220,183,166,147];c=[6,8,36,91,169,235,246,240,233];break;case 71:g=[22,19,19,25,35,53,88,139,210];f=[0,32,69,108,135,159,183,198,215];c=[77,96,110,116,110,100,90,78,70];break;case 72:g=[68,116,165,182,189,180,145,111,71];f=[37,82,135,178,204,225,221,202,147];c=[16,55,105,147,196,226,232,224,178];break;case 73:g=[61,99,136,181,213,225,198,136,24];f=[149,140,96,83,132,178,190,135,22];c=[214,203,168,135,110,100,111,113,22];break;case 74:g=[76,120,156,183,197,180,162,154,140];f=[34,35,42,69,102,137,164,188,197];c=[64,69,78,105,142,177,205,217,198];break;case 75:g=[37,102,157,188,196,214,223,235,251];f=[37,29,25,37,67,91,132,185,251];c=[37,32,33,45,66,98,137,187,251];break;case 76:g=[79,100,119,137,153,172,192,205,250];f=[63,79,93,103,115,135,167,196,250];c=[51,59,66,61,62,70,110,160,250];break;case 77:g=[43,44,50,66,125,172,178,155,157];f=[63,63,85,101,138,163,122,51,39];c=[121,101,58,44,47,55,57,44,43];break;case 78:g=[0,41,62,79,90,87,99,140,228];f=[0,57,81,93,85,70,71,125,228];c=[95,91,91,82,60,43,44,112,228];break;case 79:g=[49,59,72,88,114,141,176,205,222];f=[78,72,66,57,59,75,106,142,173];c=[78,55,46,40,39,39,40,41,47];break;case 80:g=[243,222,201,185,165,158,166,187,219];f=[94,108,132,135,125,96,68,51,61];c=[7,9,12,19,45,89,118,146,118];break;case 81:g=[19,44,74,105,137,166,194,206,220];f=[19,28,40,55,82,110,159,181,220];c=[19,42,68,96,129,157,188,203,220];break;case 82:g=[33,44,70,99,140,165,199,211,216];f=[38,50,76,105,140,165,191,189,167];c=[55,67,97,124,140,166,163,129,52];break;case 83:g=[0,33,73,124,136,152,159,171,223];f=[0,43,92,124,134,126,121,144,223];c=[0,43,68,76,73,64,72,114,223];break;case 84:g=[5,18,45,124,193,223,205,128,49];f=[48,134,207,230,193,113,28,0,7];c=[6,15,41,121,193,226,208,130,49];break;case 85:g=[180,106,104,135,164,188,189,165,144];f=[72,126,154,184,198,207,205,190,179];c=[41,120,158,188,194,181,145,100,62];break;case 86:g=[57,72,94,117,136,154,174,192,215];f=[0,33,68,109,140,171,192,196,209];c=[116,137,173,201,200,201,203,190,187];break;case 87:g=[31,71,123,160,210,222,214,199,183];f=[40,117,171,211,231,220,190,132,65];c=[234,214,228,222,210,160,105,60,34];break;case 88:g=[123,108,109,126,154,172,188,196,218];f=[184,138,130,133,154,175,188,196,218];c=[208,130,109,99,110,122,150,171,218];break;case 89:g=[105,106,122,143,159,172,176,181,207];f=[252,197,194,187,174,162,153,136,125];c=[146,133,144,155,163,167,166,162,174];break;case 90:g=[171,141,145,152,154,159,163,158,177];f=[236,143,100,63,53,55,44,31,6];c=[59,48,46,44,42,54,82,112,179];break;case 91:g=[180,190,209,223,204,228,205,152,91];f=[93,125,147,172,181,224,233,198,158];c=[236,218,160,133,114,132,162,220,218];break;case 92:g=[225,183,162,135,115,111,119,145,211];f=[205,177,166,135,124,117,117,132,172];c=[186,165,155,135,126,130,150,178,226];break;case 93:g=[39,43,59,63,80,116,153,177,223];f=[39,43,59,74,91,114,139,165,223];c=[39,50,59,70,85,115,151,176,223];break;case 94:g=[0,38,60,76,84,89,101,128,204];f=[0,10,15,23,35,57,83,123,199];c=[0,11,22,40,63,86,97,94,85];break;case 95:g=[94,112,141,165,167,140,91,49,27];f=[27,46,88,135,166,161,135,97,58];c=[42,52,81,106,139,158,155,137,116];break;case 96:g=[30,49,79,117,135,151,146,138,147];f=[63,60,72,90,94,94,68,46,16];c=[18,28,41,56,62,63,50,36,21];break;case 97:g=[0,30,63,101,143,152,169,187,230];f=[0,14,28,42,58,61,67,74,91];c=[39,26,21,18,15,14,14,13,13];break;case 98:g=[149,140,164,179,182,181,131,87,61];f=[62,70,107,136,144,138,117,87,74];c=[40,38,45,49,49,49,38,32,34];break;case 99:g=[99,112,148,165,179,182,183,183,208];f=[39,40,57,79,104,127,148,161,198];c=[15,16,18,33,51,79,103,129,177];break;case 100:g=[99,116,154,174,200,196,201,201,230];f=[0,0,8,32,58,83,119,136,173];c=[5,6,7,9,9,14,17,19,24];break;case 101:g=[82,106,126,141,155,163,142,107,66];f=[62,44,69,107,135,152,149,132,119];c=[39,25,31,60,73,68,49,72,188];break;case 102:g=[18,29,44,72,116,158,184,208,221];f=[27,46,71,105,146,177,189,190,183];c=[39,55,80,108,130,133,124,100,76];break;case 103:g=[0,48,119,173,212,224,228,228,245];f=[0,13,30,47,79,127,167,205,245];c=[0,68,75,43,16,22,55,128,245];break;case 104:g=[34,70,129,187,225,226,216,193,179];f=[48,91,147,194,226,229,196,110,12];c=[234,212,216,224,206,110,53,40,29];break;case 105:g=[30,55,103,147,174,203,188,151,105];f=[0,65,138,182,187,175,121,53,9];c=[191,202,212,208,171,140,97,57,30];break;case 106:g=[112,97,113,125,138,159,178,188,225];f=[16,17,24,37,56,81,110,136,189];c=[38,35,46,59,78,103,130,152,201];break;case 107:g=[18,72,5,23,29,201,200,98,29];f=[0,0,43,167,211,117,0,0,0];c=[51,203,177,26,10,9,8,3,0];break;case 108:g=[19,42,64,88,118,147,175,187,205];f=[19,55,89,125,154,169,161,129,70];c=[19,32,47,70,100,128,145,130,75];break;case 109:g=[33,31,42,68,86,111,141,172,227];f=[255,175,145,106,88,55,15,0,0];c=[255,205,202,203,208,205,203,206,231];break;case 110:g=[0,25,50,79,110,145,181,201,254];f=[0,16,30,46,63,82,101,124,179];c=[0,12,21,29,39,49,61,74,103];break;case 111:g=[0,13,30,44,72,120,156,200,247];f=[0,36,84,117,141,153,151,158,247];c=[0,94,100,82,56,66,76,131,247];break;case 112:g=[26,51,43,33,28,35,74,144,246];f=[9,24,55,87,118,150,180,200,222];c=[30,96,112,114,112,101,72,35,0];break;default:return a.Painter.CreateDefaultPalette()}return a.Painter.CreateGradientColorTable(e,g,f,c,255,h)};a.Painter.drawEllipse=function(e,d,c){this.ellipse=d;this.SetDivId(e);this["UpdateObject"]=function(f){a.extend(this.ellipse,f)};this["Redraw"]=function(){var n=a.Painter.createAttLine(this.ellipse);var m=this.createAttFill(this.ellipse);this.RecreateDrawG(this.main_painter()==null);var r=this.AxisToSvg("x",this.ellipse.fX1);var p=this.AxisToSvg("y",this.ellipse.fY1);var i=this.AxisToSvg("x",this.ellipse.fX1+this.ellipse.fR1)-r;var g=p-this.AxisToSvg("y",this.ellipse.fY1+this.ellipse.fR2);if((this.ellipse.fPhimin==0)&&(this.ellipse.fPhimax==360)&&(this.ellipse.fTheta==0)){this.draw_g.append("svg:ellipse").attr("cx",r.toFixed(1)).attr("cy",p.toFixed(1)).attr("rx",i.toFixed(1)).attr("ry",g.toFixed(1)).call(n.func).call(m.func);return}var l=Math.cos(Math.PI*this.ellipse.fTheta/180);var u=Math.sin(Math.PI*this.ellipse.fTheta/180);var t=i*Math.cos(this.ellipse.fPhimin*Math.PI/180);var k=g*Math.sin(this.ellipse.fPhimin*Math.PI/180);var h=t*l-k*u;var q=-t*u-k*l;var s=i*Math.cos(this.ellipse.fPhimax*Math.PI/180);var j=g*Math.sin(this.ellipse.fPhimax*Math.PI/180);var f=s*l-j*u;var o=-s*u-j*l;this.draw_g.attr("transform","translate("+r.toFixed(1)+","+p.toFixed(1)+")").append("svg:path").attr("d","M 0,0 L "+h.toFixed(1)+","+q.toFixed(1)+" A "+i.toFixed(1)+" "+g.toFixed(1)+" "+-this.ellipse.fTheta.toFixed(1)+" 1 0 "+f.toFixed(1)+","+o.toFixed(1)+" L 0,0 Z").call(n.func).call(m.func)};this.Redraw();return this.DrawingReady()};a.Painter.drawLine=function(e,d,c){this.line=d;this.SetDivId(e);this["UpdateObject"]=function(f){a.extend(this.line,f)};this["Redraw"]=function(){var f=a.Painter.createAttLine(this.line);this.RecreateDrawG(this.main_painter()==null);var h=this.AxisToSvg("x",this.line.fX1);var j=this.AxisToSvg("y",this.line.fY1);var g=this.AxisToSvg("x",this.line.fX2);var i=this.AxisToSvg("y",this.line.fY2);this.draw_g.append("svg:line").attr("x1",h.toFixed(1)).attr("y1",j.toFixed(1)).attr("x2",g.toFixed(1)).attr("y2",i.toFixed(1)).call(f.func)};this.Redraw();return this.DrawingReady()};a.Painter.drawArrow=function(e,d,c){this.arrow=d;this.SetDivId(e);this["UpdateObject"]=function(f){a.extend(this.arrow,f)};this["Redraw"]=function(){var A=a.Painter.createAttLine(this.arrow);var u=this.createAttFill(this.arrow);var f=Math.max(this.pad_width(),this.pad_height())*this.arrow.fArrowSize;if(f<3){f=3}var v=f*Math.tan(this.arrow.fAngle/2*(Math.PI/180));this.RecreateDrawG(this.main_painter()==null);var y=this.AxisToSvg("x",this.arrow.fX1);var k=this.AxisToSvg("y",this.arrow.fY1);var x=this.AxisToSvg("x",this.arrow.fX2);var i=this.AxisToSvg("y",this.arrow.fY2);var g="M0,0 L"+f.toFixed(1)+","+v.toFixed(1)+" L0,"+(v*2).toFixed(1);var q="M"+f.toFixed(1)+", 0 L 0,"+v.toFixed(1)+" L "+f.toFixed(1)+","+(v*2).toFixed(1);var m=null,n=null,s=null,h=null;var r=this.arrow.fOption;var w=r.length;if(r.indexOf("<")==0){var j=(r.indexOf("<|")==0);if(!h){h=this.draw_g.append("defs")}m="jsroot_arrowmarker_"+a.Painter.arrowcnt++;var p=h.append("svg:marker").attr("id",m).attr("markerWidth",f.toFixed(1)).attr("markerHeight",(v*2).toFixed(1)).attr("refX","0").attr("refY",v.toFixed(1)).attr("orient","auto").attr("markerUnits","userSpaceOnUse").append("svg:path").style("fill","none").attr("d",q+(j?" Z":"")).call(A.func);if(j){p.call(u.func)}}var o=0;if(r.indexOf("->-")>=0){o=1}else{if(r.indexOf("-|>-")>=0){o=11}else{if(r.indexOf("-<-")>=0){o=2}else{if(r.indexOf("-<|-")>=0){o=12}}}}if(o>0){var j=o>10;if(!h){h=this.draw_g.append("defs")}n="jsroot_arrowmarker_"+a.Painter.arrowcnt++;var z=h.append("svg:marker").attr("id",n).attr("markerWidth",f.toFixed(1)).attr("markerHeight",(v*2).toFixed(1)).attr("refX",(f*0.5).toFixed(1)).attr("refY",v.toFixed(1)).attr("orient","auto").attr("markerUnits","userSpaceOnUse").append("svg:path").style("fill","none").attr("d",((o%10==1)?g:q)+((o>10)?" Z":"")).call(A.func);if(o>10){z.call(u.func)}}if(r.lastIndexOf(">")==w-1){var j=(r.lastIndexOf("|>")==w-2)&&(w>1);if(!h){h=this.draw_g.append("defs")}s="jsroot_arrowmarker_"+a.Painter.arrowcnt++;var l=h.append("svg:marker").attr("id",s).attr("markerWidth",f.toFixed(1)).attr("markerHeight",(v*2).toFixed(1)).attr("refX",f.toFixed(1)).attr("refY",v.toFixed(1)).attr("orient","auto").attr("markerUnits","userSpaceOnUse").append("svg:path").style("fill","none").attr("d",g+(j?" Z":"")).call(A.func);if(j){l.call(u.func)}}var t=this.draw_g.append("svg:path").attr("d","M"+y.toFixed(1)+","+k.toFixed(1)+((n==null)?"":"L"+(y/2+x/2).toFixed(1)+","+(k/2+i/2).toFixed(1))+" L"+x.toFixed(1)+","+i.toFixed(1)).call(A.func);if(m!=null){t.style("marker-start","url(#"+m+")")}if(n!=null){t.style("marker-mid","url(#"+n+")")}if(s!=null){t.style("marker-end","url(#"+s+")")}};if(!("arrowcnt" in a.Painter)){a.Painter.arrowcnt=0}this.Redraw();return this.DrawingReady()};a.Painter.drawFunction=function(f,e,d){this["tf1"]=e;this["bins"]=null;this["GetObject"]=function(){return this.tf1};this["Redraw"]=function(){this.DrawBins()};this["Eval"]=function(g){return this.tf1.evalPar(g)};this["CreateDummyHisto"]=function(){var g=0,p=0,r=0,j=0;if(this.tf1.fSave.length>0){var m=this.tf1.fNpx;for(var o=0;o<m;++o){var q=this.tf1.fSave[o];if((o==0)||(q>j)){j=q}if((o==0)||(q<r)){r=q}}g=this.tf1.fSave[m+1];p=this.tf1.fSave[m+2]}else{if(this.tf1.fNpfits<=103){this.tf1.fNpfits=103}g=this.tf1.fXmin;p=this.tf1.fXmax;var m=Math.max(this.tf1.fNpx,this.tf1.fNpfits);var l=(p-g)/m;var k=-1,s=-1;for(var o=0;o<m;++o){var q=this.Eval(g+(o*l));if(isNaN(q)){continue}if(k<0){k=o;j=q;r=q}if((s<0)||(s==o-1)){s=o}if(q>j){j=q}if(q<r){r=q}}if(k<s){p=g+s*l;g=g+k*l}}if(j>0){j*=1.05}if(r<0){r*=1.05}var n=a.Create("TH1I");n.fName=this.tf1.fName+"_hist";n.fTitle=this.tf1.fTitle;n.fXaxis["fXmin"]=g;n.fXaxis["fXmax"]=p;n.fYaxis["fXmin"]=r;n.fYaxis["fXmax"]=j;return n};this["CreateBins"]=function(){var h=this;if(this.tf1.fSave.length>0){var l=this.tf1.fNpx;var k=this.tf1.fSave[l+1];var i=this.tf1.fSave[l+2];var j=(i-k)/l;this["bins"]=b.range(l).map(function(n){return{x:k+(n*j),y:h.tf1.fSave[n]}});this["interpolate_method"]="monotone"}else{var g=this.main_painter();if(this.tf1.fNpfits<=103){this.tf1.fNpfits=333}var k=this.tf1.fXmin,i=this.tf1.fXmax,m=false;if(g.zoom_xmin!=g.zoom_xmax){if(g.zoom_xmin>k){k=g.zoom_xmin}if(g.zoom_xmax<i){i=g.zoom_xmax}}if(g.options.Logx&&(k>0)&&(i>0)){m=true;k=Math.log(k);i=Math.log(i)}var l=Math.max(this.tf1.fNpx,this.tf1.fNpfits);var j=(i-k)/l;this["bins"]=b.range(l).map(function(n){var o=k+(n*j);if(m){o=Math.exp(o)}var q=h.Eval(o);if(isNaN(q)){q=0}return{x:o,y:q}});this["interpolate_method"]="monotone"}};this["DrawBins"]=function(){var n=this.frame_width(),l=this.frame_height();this.RecreateDrawG(false,".main_layer",false);if((this["bins"]==null)||(this.tf1.fSave.length==0)){this.CreateBins()}var j=this;var m=this.main_painter();var i=this.GetItemName();if((i==null)||(i=="")){i=this.tf1.fName}if(i.length>0){i+="\n"}var g=a.Painter.createAttLine(this.tf1);var o=this.createAttFill(this.tf1);if(o.color=="white"){o.color="none"}var p=b.svg.line().x(function(h){return m.grx(h.x).toFixed(1)}).y(function(h){return m.gry(h.y).toFixed(1)}).interpolate(this.interpolate_method);var k=b.svg.area().x(function(h){return m.grx(h.x).toFixed(1)}).y1(l).y0(function(h){return m.gry(h.y).toFixed(1)});if(g.color!="none"){this.draw_g.append("svg:path").attr("class","line").attr("d",p(j.bins)).style("fill","none").call(g.func)}if(o.color!="none"){this.draw_g.append("svg:path").attr("class","area").attr("d",k(j.bins)).style("stroke","none").style("pointer-events","none").call(o.func)}if(a.gStyle.Tooltip){this.draw_g.selectAll().data(this.bins).enter().append("svg:circle").attr("cx",function(h){return m.grx(h.x).toFixed(1)}).attr("cy",function(h){return m.gry(h.y).toFixed(1)}).attr("r",4).style("opacity",0).append("svg:title").text(function(h){return i+"x = "+m.AxisAsText("x",h.x)+" \ny = "+m.AxisAsText("y",h.y)})}};this["UpdateObject"]=function(g){if(g._typename!=this.tf1._typename){return false}this.tf1=g;return true};this["CanZoomIn"]=function(j,i,g){if(j!="x"){return false}if(this.tf1.fSave.length>0){var l=this.tf1.fNpx;var k=this.tf1.fSave[l+1];var h=this.tf1.fSave[l+2];return Math.abs(k-h)/l<Math.abs(i-g)}return true};this.SetDivId(f,-1);if(this.main_painter()==null){var c=this.CreateDummyHisto();a.Painter.drawHistogram1D(f,c,"AXIS")}this.SetDivId(f);this.DrawBins();return this.DrawingReady()};a.Painter.drawHStack=function(e,c,d){this.stack=c;this.nostack=false;this.firstpainter=null;this.painters=new Array;this.SetDivId(e);if(!("fHists" in c)||(c.fHists.arr.length==0)){return this.DrawingReady()}this["GetObject"]=function(){return this.stack};this["BuildStack"]=function(){if(!("fHists" in this.stack)){return false}var g=this.stack.fHists.arr.length;if(g<=0){return false}var f=a.Create("TList");f.Add(a.clone(this.stack.fHists.arr[0]));for(var k=1;k<g;++k){var h=a.clone(this.stack.fHists.arr[k]);var j=f.arr[k-1];if((h.fNbins!=j.fNbins)||(h.fXaxis["fXmin"]!=j.fXaxis["fXmin"])||(h.fXaxis["fXmax"]!=j.fXaxis["fXmax"])){a.console("When drawing THStack, cannot sum-up histograms "+h.fName+" and "+j.fName);delete h;delete f;return false}for(var l=0;l<h.fArray.length;++l){h.fArray[l]+=j.fArray[l]}f.Add(h)}this.stack.fStack=f;return true};this["GetHistMinMax"]=function(j,m){var k={min:0,max:0};var l=false,f=false;if(j.fMinimum!=-1111){k.min=j.fMinimum}else{l=true}if(j.fMaximum!=-1111){k.max=j.fMaximum}else{f=true}if(l||f){var h=1,n=j.fXaxis.fNbins;if(j.fXaxis.TestBit(a.EAxisBits.kAxisRange)){h=j.fXaxis.fFirst;n=j.fXaxis.fLast}for(var o=h;o<=n;++o){var g=j.getBinContent(o);var i=m?j.getBinError(o):0;if(l&&((o==h)||(g-i<k.min))){k.min=g-i}if(f&&((o==h)||(g+i>k.max))){k.max=g+i}}}return k};this["GetMinMax"]=function(h){var g={min:0,max:0};var j=h.indexOf("e")>=0;if(this.nostack){for(var f=0;f<this.stack.fHists.arr.length;++f){var k=this.GetHistMinMax(this.stack.fHists.arr[f],j);if(f==0){g=k}else{if(k.min<g.min){g.min=k.min}if(k.max>g.max){g.max=k.max}}}if(this.stack.fMaximum!=-1111){g.max=this.stack.fMaximum}else{g.max=g.max*1.05}if(this.stack.fMinimum!=-1111){g.min=this.stack.fMinimum}}else{g.min=this.GetHistMinMax(this.stack.fStack.arr[0],j).min;g.max=this.GetHistMinMax(this.stack.fStack.arr[this.stack.fStack.arr.length-1],j).max*1.05}var l=this.root_pad();if((l!=null)&&(l.fLogy>0)){if(g.min<0){g.min=g.max*0.0001}}return g};this["DrawNextHisto"]=function(i,h){var g=this.stack.fHists.arr.length;if(i>=g){return this.DrawingReady()}var k=null;if(i<0){k=this.stack.fHistogram}else{if(this.nostack){k=this.stack.fHists.arr[i]}else{k=this.stack.fStack.arr[g-i-1]}}var f=k.fOption;if((h!="")&&(f.indexOf(h)==-1)){f+=h}if(i>=0){f+="same"}var j=a.draw(this.divid,k,f);if(i<0){this.firstpainter=j}else{this.painters.push(j)}j.WhenReady(this.DrawNextHisto.bind(this,i+1,h))};this["drawStack"]=function(g){var k=this.root_pad();var o=this.stack.fHists;var t=o.arr.length;var k=this.root_pad();if(g==null){g=""}else{g=g.toLowerCase()}var n=false;if(g.indexOf("same")!=-1){n=true;g.replace("same","")}this.nostack=g.indexOf("nostack")<0?false:true;if(!this.nostack){this.nostack=!this.BuildStack()}var l=this.GetMinMax(g);if(this.stack.fHistogram==null){var f=0,q=0,s=0,j=0;for(var p=0;p<t;++p){var r=o.arr[p];if(p==0||r.fXaxis["fXmin"]<f){f=r.fXaxis["fXmin"]}if(p==0||r.fXaxis["fXmax"]>q){q=r.fXaxis["fXmax"]}if(p==0||r.fYaxis["fXmin"]<s){s=r.fYaxis["fXmin"]}if(p==0||r.fYaxis["fXmax"]>j){j=r.fYaxis["fXmax"]}}var r=this.stack.fHists.arr[0];this.stack.fHistogram=a.Create("TH1I");this.stack.fHistogram["fName"]="unnamed";this.stack.fHistogram["fXaxis"]=a.clone(r.fXaxis);this.stack.fHistogram["fYaxis"]=a.clone(r.fYaxis);this.stack.fHistogram["fXaxis"]["fXmin"]=f;this.stack.fHistogram["fXaxis"]["fXmax"]=q;this.stack.fHistogram["fYaxis"]["fXmin"]=s;this.stack.fHistogram["fYaxis"]["fXmax"]=j}this.stack.fHistogram["fTitle"]=this.stack.fTitle;var m=this.stack.fHistogram;if(!m.TestBit(a.TH1StatusBits.kIsZoomed)){if(k&&k.fLogy){m.fMaximum=l.max*(1+0.2*a.log10(l.max/l.min))}else{m.fMaximum=l.max}if(k&&k.fLogy){m.fMinimum=l.min/(1+0.5*a.log10(l.max/l.min))}else{m.fMinimum=l.min}}console.log("Drawing histograms "+!n);this.DrawNextHisto(!n?-1:0,g);return this};this["UpdateObject"]=function(k){var h=false;if(this.firstpainter){if(this.firstpainter.UpdateObject(k.fHistogram)){h=true}}var f=k.fHists.arr.length;for(var g=0;g<f;++g){var j=this.nostack?k.fHists.arr[g]:k.fStack.arr[f-g-1];if(this.painters[g].UpdateObject(j)){h=true}}return h};return this.drawStack(d)};a.Painter.drawMultiGraph=function(e,d,c){this.mgraph=d;this.firstpainter=null;this.painters=new Array;this.SetDivId(e);this["GetObject"]=function(){return this.mgraph};this["UpdateObject"]=function(k){if((k==null)||(k._typename!="TMultiGraph")){return false}var g=k.fHistogram;var f=k.fGraphs;var j=false;if(this.firstpainter&&g){if(this.firstpainter.UpdateObject(g)){j=true}}for(var h=0;h<f.arr.length;++h){if(h>=this.painters.length){break}if(this.painters[h].UpdateObject(f.arr[h])){j=true}}return j};this["ComputeGraphRange"]=function(h,f){if(f.fNpoints==0){return}if(h.first){h.xmin=h.xmax=f.fX[0];h.ymin=h.ymax=f.fY[0];h.first=false}for(var g=0;g<f.fNpoints;++g){if(f.fX[g]<h.xmin){h.xmin=f.fX[g]}if(f.fX[g]>h.xmax){h.xmax=f.fX[g]}if(f.fY[g]<h.ymin){h.ymin=f.fY[g]}if(f.fY[g]>h.ymax){h.ymax=f.fY[g]}}return h};this["padtoX"]=function(g,f){if(g.fLogx&&f<50){return Math.exp(2.302585092994*f)}return f};this["DrawAxis"]=function(){var j,p,u,t;var f={xmin:0,xmax:0,ymin:0,ymax:0,first:true};var s=0,h=0;var n=1,m=1,r=false,q=false;var k=this.mgraph.fHistogram;var o=this.mgraph.fGraphs;var g=this.root_pad();if(g!=null){f.xmin=g.fUxmin;f.xmax=g.fUxmax;f.ymin=g.fUymin;f.ymax=g.fUymax;f.first=false;r=g.fLogx;q=g.fLogy}if(k!=null){p=k.fYaxis["fXmin"];j=k.fYaxis["fXmax"];if(g!=null){s=this.padtoX(g,f.xmin);h=this.padtoX(g,f.xmax)}}else{for(var l=0;l<o.arr.length;++l){this.ComputeGraphRange(f,o.arr[l])}if(f.xmin==f.xmax){f.xmax+=1}if(f.ymin==f.ymax){f.ymax+=1}u=0.05*(f.xmax-f.xmin);t=0.05*(f.ymax-f.ymin);s=f.xmin-u;h=f.xmax+u;if(q){if(f.ymin<=0){f.ymin=0.001*f.ymax}p=f.ymin/(1+0.5*a.log10(f.ymax/f.ymin));j=f.ymax*(1+0.2*a.log10(f.ymax/f.ymin))}else{p=f.ymin-t;j=f.ymax+t}if(p<0&&f.ymin>=0){p=0}if(j>0&&f.ymax<=0){j=0}}if(this.mgraph.fMinimum!=-1111){f.ymin=p=this.mgraph.fMinimum}if(this.mgraph.fMaximum!=-1111){f.ymax=j=this.mgraph.fMaximum}if(s<0&&f.xmin>=0){if(r){s=0.9*f.xmin}}if(h>0&&f.xmax<=0){if(r){h=1.1*f.xmax}}if(p<0&&f.ymin>=0){if(q){p=0.9*f.ymin}}if(j>0&&f.ymax<=0){if(q){j=1.1*f.ymax}}if(p<=0&&q){p=0.001*j}if(s<=0&&r){if(h>1000){s=1}else{s=0.001*h}}f.ymin=p;f.ymax=j;if(k!=null){k.fYaxis["fXmin"]=f.ymin;k.fYaxis["fXmax"]=f.ymax}if(!k){k=a.Create("TH1I");k.fTitle=this.mgraph.fTitle;k.fXaxis["fXmin"]=f.xmin;k.fXaxis["fXmax"]=f.xmax;k.fYaxis["fXmin"]=f.ymin;k.fYaxis["fXmax"]=f.ymax}this.firstpainter=a.Painter.drawHistogram1D(this.divid,k,"AXIS")};this["DrawNextFunction"]=function(i,j){if((this.mgraph.fFunctions==null)||(i>=this.mgraph.fFunctions.arr.length)){return a.CallBack(j)}var h=this.mgraph.fFunctions.arr[i];var g=this.mgraph.fFunctions.opt[i];var f=a.draw(this.divid,h,g);if(f){return f.WhenReady(this.DrawNextFunction.bind(this,i+1,j))}this.DrawNextFunction(i+1,j)};this["DrawNextGraph"]=function(i,h){var f=this.mgraph.fGraphs;if(i>=f.arr.length){return this.DrawNextFunction(0,this.DrawingReady.bind(this))}var g=f.opt[i];if((g==null)||(g=="")){g=h}var j=a.Painter.drawGraph(this.divid,f.arr[i],g);this.painters.push(j);j.WhenReady(this.DrawNextGraph.bind(this,i+1,h))};if(c==null){c=""}c=c.toUpperCase().replace("3D","").replace("FB","");if(c.indexOf("A")<0){if(this.main_painter()==null){a.console("Most probably, drawing of multigraph will fail")}}else{c=c.replace("A","");this.DrawAxis()}this.DrawNextGraph(0,c);return this};a.Painter.drawLegend=function(e,d,c){this.legend=d;this.SetDivId(e);this["GetObject"]=function(){return this.legend};this["Redraw"]=function(){this.RecreateDrawG(true,".text_layer");var s=this.legend;var v=0,u=0,B=0,J=0;if(s.fInit==0){v=s.fX1*this.pad_width();u=(1-s.fY2)*this.pad_height();B=(s.fX2-s.fX1)*this.pad_width();J=(s.fY2-s.fY1)*this.pad_height()}else{v=s.fX1NDC*this.pad_width();u=(1-s.fY2NDC)*this.pad_height();B=(s.fX2NDC-s.fX1NDC)*this.pad_width();J=(s.fY2NDC-s.fY1NDC)*this.pad_height()}var M=s.fBorderSize?s.fBorderSize:0;var E=this.createAttFill(s);var Q=a.Painter.createAttLine(s,M);var r=s.fNColumns,F=s.fPrimitives.arr.length;var p=F;if(r>1){while((p-1)*r>=F){p--}}else{r=1}this.draw_g.attr("x",v.toFixed(1)).attr("y",u.toFixed(1)).attr("width",B.toFixed(1)).attr("height",J.toFixed(1)).attr("transform","translate("+v.toFixed(1)+","+u.toFixed(1)+")");this.StartTextDrawing(s.fTextFont,J/(F*1.2));this.draw_g.append("svg:rect").attr("x",0).attr("y",0).attr("width",B.toFixed(1)).attr("height",J.toFixed(1)).call(E.func).style("stroke-width",M?1:0).style("stroke",Q.color);var S=a.Painter.root_colors[s.fTextColor];var t=Math.round(B/r);var D=Math.round(0.03*B/r);var C=Math.round(0.03*J);var z=this;var A=(J-2*C)/p;var k=false;for(var I=0;I<F;++I){var N=s.fPrimitives.arr[I];var l=N.fOption.toLowerCase();var L=I%r,P=(I-L)/r;var K=L*t;var n=K+Math.round(s.fMargin*t);var f=Math.round(C+P*A);var R=Math.round(C+(P+0.5)*A);var o=N;var O=N;var j=N;var H=N.fObject;if((H!=null)&&(typeof H=="object")){if("fLineColor" in H){j=H}if("fFillColor" in H){o=H}if("fMarkerColor" in H){O=H}}var G=this.createAttFill(o);var m=a.Painter.createAttLine(j);if(l.indexOf("f")!=-1){this.draw_g.append("svg:rect").attr("x",K+D).attr("y",Math.round(f+A*0.1)).attr("width",n-2*D-K).attr("height",Math.round(A*0.8)).call(G.func)}if(l.indexOf("l")!=-1){this.draw_g.append("svg:line").attr("x1",K+D).attr("y1",R).attr("x2",n-D).attr("y2",R).call(m.func)}if(l.indexOf("e")!=-1&&(l.indexOf("l")==-1||l.indexOf("f")!=-1)){}if(l.indexOf("p")!=-1){var q=a.Painter.createAttMarker(O);this.draw_g.append("svg:path").attr("transform",function(h){return"translate("+(K+n)/2+","+R+")"}).call(q.func)}var g=n;if(l.length>0){k=true}else{if(!k){g=K+D}}this.DrawText("start",g,f,K+t-g-D,A,N.fLabel,S)}if(M&&M>1){this.draw_g.append("svg:line").attr("x1",B+(M/2)).attr("y1",M+1).attr("x2",B+(M/2)).attr("y2",J+M-1).call(Q.func);this.draw_g.append("svg:line").attr("x1",M+1).attr("y1",J+(M/2)).attr("x2",B+M-1).attr("y2",J+(M/2)).call(Q.func)}this.AddDrag({obj:s,redraw:this.Redraw.bind(this)});this.FinishTextDrawing()};this.Redraw();return this.DrawingReady()};a.Painter.drawPaletteAxis=function(d,c){this.palette=c;this.SetDivId(d);this["GetObject"]=function(){return this.palette};this["DrawPalette"]=function(){var J=this.palette;var j=J.fAxis;var q=j.fNdiv%100;if(q<=0){q=8}var C=this.pad_width(),A=this.pad_height();var K=Math.round(Math.abs(J.fY2NDC-J.fY1NDC)*A);var l=j.fLabelOffset*C;var B=j.fTickSize*C;if(this.main_painter().fContour==null){this.main_painter().getValueColor(this.main_painter().minbin)}var D=this.main_painter().fContour;var L=D[0],N=D[D.length-1];var s=null;if(this.main_painter().options.Logz){s=b.scale.log();this["noexpz"]=((N<300)&&(L>0.3));this["formatz"]=function(z){var r=parseFloat(z);var i=a.log10(r);if(Math.abs(i-Math.round(i))<0.001){if(!this["noexpz"]){return a.Painter.formatExp(r.toExponential(0))}else{if(i<0){return r.toFixed(Math.round(-i+0.5))}else{return r.toFixed(0)}}}return null}}else{s=b.scale.linear();this["formatz"]=function(i){if((Math.abs(i)<1e-14)&&(Math.abs(N-L)>0.00001)){i=0}return parseFloat(i.toPrecision(12))}}s.domain([L,N]).range([K,0]);var k=a.Painter.getFontDetails(j.fLabelFont,j.fLabelSize*A);var g=Math.round(J.fX1NDC*C);var f=Math.round(A*(1-J.fY1NDC));var p=Math.round(Math.abs(J.fX2NDC-J.fX1NDC)*C);f-=K;if(B>p*0.8){B=p*0.8}this.RecreateDrawG(true,".text_layer");this.draw_g.attr("x",g).attr("y",f).attr("width",p).attr("height",K).attr("transform","translate("+g+", "+f+")");for(var I=0;I<D.length-1;++I){var w=s(D[I]);var u=s(D[I+1]);var n=this.main_painter().getValueColor(D[I]);var x=this.draw_g.append("svg:rect").attr("x",0).attr("y",u.toFixed(1)).attr("width",p).attr("height",(w-u).toFixed(1)).attr("fill",n).property("fill0",n).attr("stroke",n);if(a.gStyle.Tooltip){x.on("mouseover",function(){if(a.gStyle.Tooltip){b.select(this).transition().duration(100).style("fill","grey")}}).on("mouseout",function(){b.select(this).transition().duration(100).style("fill",this["fill0"])}).append("svg:title").text(D[I].toFixed(2)+" - "+D[I+1].toFixed(2))}}var H=b.svg.axis().scale(s).orient("right").tickPadding(l).tickSize(-B,-B/2,0).ticks(q).tickFormat(this.formatz.bind(this));var O=this.draw_g.append("svg:g").attr("class","zaxis").attr("transform","translate("+p+", 0)").call(H);O.selectAll("text").call(k.func).attr("fill",a.Painter.root_colors[j.fLabelColor]);if((j.fTitle!="")&&(typeof j.fTextFont!="undefined")){var v=j.fTitleOffset*p;if("getBoundingClientRect" in this.draw_g.node()){var y=this.draw_g.node().getBoundingClientRect();v=j.fTitleOffset*(y.width-p)}v+=p+j.fTitleSize*A*1.3;if(g+v>C-3){v=C-3-g}var P=a.Painter.root_colors[j.fTextColor];this.StartTextDrawing(j.fTextFont,j.fTitleSize*A);this.DrawText(33,0,v,0,-270,j.fTitle,P);this.FinishTextDrawing()}this.AddDrag({obj:J,redraw:this.DrawPalette.bind(this),ctxmenu:a.touches&&a.gStyle.ContextMenu});if(a.gStyle.ContextMenu&&!a.touches){this.draw_g.on("contextmenu",this.ShowContextMenu.bind(this))}if(!a.gStyle.Zooming){return}var m=this,o=null,M=false,F=0,E=0,e=null;function t(){if(!M){return}b.event.preventDefault();var i=b.mouse(o);if(i[1]<F){F=i[1]}else{E=i[1]}e.attr("y",F).attr("height",Math.abs(E-F))}function h(){if(!M){return}b.event.preventDefault();b.select(window).on("mousemove.colzoomRect",null).on("mouseup.colzoomRect",null);e.remove();e=null;M=false;var i=Math.min(s.invert(F),s.invert(E));var r=Math.max(s.invert(F),s.invert(E));m.main_painter().Zoom(0,0,0,0,i,r)}function G(){if(M){return}M=true;b.event.preventDefault();o=this;var i=b.mouse(o);F=E=i[1];e=m.draw_g.append("svg:rect").attr("class","zoom").attr("id","colzoomRect").attr("x","0").attr("width",p).attr("y",F).attr("height",5);b.select(window).on("mousemove.colzoomRect",t).on("mouseup.colzoomRect",h,true);b.event.stopPropagation()}this.draw_g.append("svg:rect").attr("x",p).attr("y",0).attr("width",20).attr("height",K).style("cursor","crosshair").style("opacity","0").on("mousedown",G)};this["ShowContextMenu"]=function(e,f){this.main_painter().ShowContextMenu("z",f)};this["Redraw"]=function(){var e=true;if("options" in this.main_painter()){e=(this.main_painter().options.Zscale>0)&&(this.main_painter().options.Color>0)}if(e){this.DrawPalette()}else{this.RemoveDrawG()}};this.DrawPalette();return this.DrawingReady()};a.TH2Painter=function(c){a.THistPainter.call(this,c);this.fContour=null;this.fUserContour=false;this.fPalette=null};a.TH2Painter.prototype=Object.create(a.THistPainter.prototype);a.TH2Painter.prototype.FillContextMenu=function(c){a.THistPainter.prototype.FillContextMenu.call(this,c);c.add("Auto zoom-in",this.AutoZoom.bind(this));c.add("Draw in 3D",this.Draw3D.bind(this));c.add("Toggle col",function(){if(this.options.Color==0){this.options.Color=a.gStyle.DefaultCol}else{this.options.Color=-this.options.Color}this.RedrawPad()});if(this.options.Color>0){c.add("Toggle colz",this.ToggleColz.bind(this))}};a.TH2Painter.prototype.FindPalette=function(c){if("fFunctions" in this.histo){for(var d=0;d<this.histo.fFunctions.arr.length;++d){var e=this.histo.fFunctions.arr[d];if(e._typename!="TPaletteAxis"){continue}if(c){this.histo.fFunctions.RemoveAt(d);return null}return e}}return null};a.TH2Painter.prototype.ToggleColz=function(){if(this.FindPalette()==null){var c=this.CreatePalette(0.04);this.svg_frame().property("frame_painter").Shrink(0,c);this.options.Zscale=1;a.draw(this.divid,this.FindPalette())}else{if(this.options.Zscale>0){this.options.Zscale=0}else{this.options.Zscale=1}}this.RedrawPad()};a.TH2Painter.prototype.AutoZoom=function(){var k=this.GetSelectIndex("x","left",-1);var h=this.GetSelectIndex("x","right",1);var s=this.GetSelectIndex("y","left",-1);var r=this.GetSelectIndex("y","right",1);if((k==h)||(s==r)){return}var m=this.histo.getBinContent(k+1,s+1);for(var p=k;p<h;++p){for(var n=s;n<r;++n){if(this.histo.getBinContent(p+1,n+1)<m){m=this.histo.getBinContent(p+1,n+1)}}}if(m>0){return}var f=h,e=k,c=r,l=s;for(var p=k;p<h;++p){for(var n=s;n<r;++n){if(this.histo.getBinContent(p+1,n+1)>m){if(p<f){f=p}if(p>=e){e=p+1}if(n<c){c=n}if(n>=l){l=n+1}}}}var d=0,o=0,q=0,g=0;if((f>k||e<h)&&(f<e-1)){d=this.GetBinX(f);o=this.GetBinX(e)}if((c>s||l<r)&&(c<l-1)){q=this.GetBinY(c);g=this.GetBinY(l)}this.Zoom(d,o,q,g)};a.TH2Painter.prototype.CreatePalette=function(o){if(this.FindPalette()!=null){return 0}if(!o||o<=0){o=0.04}var p={};p._typename="TPaletteAxis";p.fName="palette";p._AutoCreated=true;var n=this.svg_frame().property("NDC");p.fX1NDC=n.fX2NDC-o;p.fY1NDC=n.fY1NDC;p.fX2NDC=n.fX2NDC;p.fY2NDC=n.fY2NDC;p.fInit=1;p.fShadowColor=1;p.fCorenerRadius=0;p.fResizing=false;p.fBorderSize=4;p.fName="TPave";p.fOption="br";p.fLineColor=1;p.fLineSyle=1;p.fLineWidth=1;p.fFillColor=1;p.fFillSyle=1;var g={};g._typename="TGaxis";g.fTickSize=0.03;g.fLabelOffset=0.005;g.fLabelSize=0.035;g.fTitleOffset=1;g.fTitleSize=0.035;g.fNdiv=8;g.fLabelColor=1;g.fLabelFont=42;g.fChopt="";g.fName="";g.fTitle=this.histo.fZaxis.fTitle;g.fTimeFormat="";g.fFunctionName="";g.fWmin=0;g.fWmax=100;g.fLineColor=1;g.fLineSyle=1;g.fLineWidth=1;g.fTextAngle=0;g.fTextSize=0.04;g.fTextAlign=11;g.fTextColor=1;g.fTextFont=42;p.fAxis=g;if(!"fFunctions" in this.histo){this.histo.fFunctions=a.Create("TList")}this.histo.fFunctions.AddFirst(p);var d=this.frame_width(),q=this.frame_height();var l=Math.round(g.fLabelOffset*d);var j=Math.round(g.fTickSize*d);var c=a.Painter.getFontDetails(g.fLabelFont,g.fLabelSize*q);var m=b.scale.linear().clamp(true).domain([this.gminbin,this.gmaxbin]).range([q,0]).nice().ticks(g.fNdiv%100);var f=0;for(var h=0;h<m.length;++h){var k=c.stringWidth(this.svg_frame(),m[h]);if(k>f){f=k}}var r=(f+5+l)/d;if(p.fX2NDC+r>0.98){var e=p.fX2NDC+r-0.98;p.fX1NDC-=e;p.fX2NDC-=e;o+=e}return o+0.01};a.TH2Painter.prototype.ScanContent=function(){this.fillcolor=a.Painter.root_colors[this.histo.fFillColor];this.attline=a.Painter.createAttLine(this.histo);if(this.attline.color=="none"){this.attline.color="#4572A7"}this.nbinsx=this.histo.fXaxis["fNbins"];this.nbinsy=this.histo.fYaxis["fNbins"];this.CreateAxisFuncs(true);this.gmaxbin=this.histo.getBinContent(1,1);this.gminbin=this.gmaxbin;for(var d=0;d<this.nbinsx;++d){for(var c=0;c<this.nbinsy;++c){var e=this.histo.getBinContent(d+1,c+1);if(e<this.gminbin){this.gminbin=e}else{if(e>this.gmaxbin){this.gmaxbin=e}}}}this.draw_content=this.gmaxbin>0};a.TH2Painter.prototype.CountStat=function(i){var e=0,h=0,p=0,g=0,o=0,s=0;var w={entries:0,integral:0,meanx:0,meany:0,rmsx:0,rmsy:0,matrix:[],xmax:0,ymax:0,wmax:null};for(var m=0;m<9;++m){w.matrix.push(0)}var d=this.GetSelectIndex("x","left");var l=this.GetSelectIndex("x","right");var t=this.GetSelectIndex("y","left");var r=this.GetSelectIndex("y","right");for(var k=0;k<=this.nbinsx+1;++k){var c=(k<=d)?0:(k>l?2:1);var f=this.GetBinX(k-0.5);for(var v=0;v<=this.nbinsx+1;++v){var q=(v<=t)?0:(v>r?2:1);var j=this.ymin+this.GetBinY(v-0.5);var u=this.histo.getBinContent(k,v);w.entries+=u;w.matrix[q*3+c]+=u;if((c!=1)||(q!=1)){continue}if((i!=null)&&!i(f,j)){continue}if((w.wmax==null)||(u>w.wmax)){w.wmax=u;w.xmax=f;w.ymax=j}e+=u;h+=f*u;p+=j*u;g+=f*f*u;o+=j*j*u;s+=f*j*u}}if(!this.IsAxisZoomed("x")&&!this.IsAxisZoomed("y")&&(this.histo.fTsumw>0)){e=this.histo.fTsumw;h=this.histo.fTsumwx;g=this.histo.fTsumwx2;p=this.histo.fTsumwy;o=this.histo.fTsumwy2;s=this.histo.fTsumwxy}if(e>0){w.meanx=h/e;w.meany=p/e;w.rmsx=Math.sqrt(g/e-w.meanx*w.meanx);w.rmsy=Math.sqrt(o/e-w.meany*w.meany)}if(w.wmax==null){w.wmax=0}w.integral=e;if(this.histo.fEntries>1){w.entries=this.histo.fEntries}return w};a.TH2Painter.prototype.FillStatistic=function(i,j,s){if(!this.histo){return false}var h=this.CountStat();var n=Math.floor(j%10);var p=Math.floor(j/10)%10;var l=Math.floor(j/100)%10;var q=Math.floor(j/1000)%10;var c=Math.floor(j/10000)%10;var d=Math.floor(j/100000)%10;var f=Math.floor(j/1000000)%10;var k=Math.floor(j/10000000)%10;var g=Math.floor(j/100000000)%10;if(n>0){i.AddLine(this.histo.fName)}if(p>0){i.AddLine("Entries = "+i.Format(h.entries,"entries"))}if(l>0){i.AddLine("Mean x = "+i.Format(h.meanx));i.AddLine("Mean y = "+i.Format(h.meany))}if(q>0){i.AddLine("Std Dev x = "+i.Format(h.rmsx));i.AddLine("Std Dev y = "+i.Format(h.rmsy))}if(f>0){i.AddLine("Integral = "+i.Format(h.matrix[4],"entries"))}if(k>0){i.AddLine("Skewness x = <undef>");i.AddLine("Skewness y = <undef>")}if(g>0){i.AddLine("Kurt = <undef>")}if((c>0)||(d>0)){var e=h.matrix;i.AddLine(""+e[6].toFixed(0)+" | "+e[7].toFixed(0)+" | "+e[7].toFixed(0));i.AddLine(""+e[3].toFixed(0)+" | "+e[4].toFixed(0)+" | "+e[5].toFixed(0));i.AddLine(""+e[0].toFixed(0)+" | "+e[1].toFixed(0)+" | "+e[2].toFixed(0))}var o=i.pavetext.fLines.arr.length;var r=o*a.gStyle.StatFontSize;if(r<=0||3==(a.gStyle.StatFont%10)){r=0.25*o*a.gStyle.StatH;i.pavetext.fY1NDC=0.93-r;i.pavetext.fY2NDC=0.93}return true};a.TH2Painter.prototype.getValueColor=function(d){if(this.fContour==null){this.fUserContour=false;if((this.histo.fContour!=null)&&(this.histo.fContour.length>1)&&this.histo.TestBit(a.TH1StatusBits.kUserContour)){this.fContour=a.clone(this.histo.fContour);this.fUserContour=true}else{var h=20;if(this.histo.fContour!=null){h=this.histo.fContour.length}if(h<1){h=20}this.fContour=[];this.zmin=this.minbin;this.zmax=this.maxbin;if(this.zoom_zmin!=this.zoom_zmax){this.zmin=this.zoom_zmin;this.zmax=this.zoom_zmax}if(this.options.Logz){if(this.zmax<=0){this.zmax=1}if(this.zmin<=0){this.zmin=0.001*this.zmax}var l=Math.log(this.zmin)/Math.log(10);var e=Math.log(this.zmax)/Math.log(10);var j=(e-l)/h;this.fContour.push(this.zmin);for(var c=1;c<h;c++){this.fContour.push(Math.exp((l+j*c)*Math.log(10)))}this.fContour.push(this.zmax)}else{if((this.zmin==this.zmax)&&(this.zmin!=0)){this.zmax+=0.01*Math.abs(this.zmax);this.zmin-=0.01*Math.abs(this.zmin)}var j=(this.zmax-this.zmin)/h;for(var c=0;c<=h;c++){this.fContour.push(this.zmin+j*c)}}}}var f=-1;if(this.fUserContour||this.options.Logz){for(var g=0;g<this.fContour.length;++g){if(d>=this.fContour[g]){f++}}}else{f=Math.floor(0.01+(d-this.zmin)*(this.fContour.length-1)/(this.zmax-this.zmin))}if(f<0){if(this.options.Color!=111){return null}f=0}if(this.fPalette==null){this.fPalette=a.Painter.GetColorPalette(this.options.Palette)}var i=Math.floor((f+0.99)*this.fPalette.length/(this.fContour.length-1));if(i>this.fPalette.length-1){i=this.fPalette.length-1}return this.fPalette[i]};a.TH2Painter.prototype.CompressAxis=function(j,e,c){if(j.length<=e){return}var d=0,o=j.length-2;while((d<o)&&(j[d].cnt===0)){++d}while((d<o)&&(j[o].cnt===0)){--o}if((d==o)||(o-d<e)){return}function n(){var i=o;while(i>d){while((i>d)&&(j[i]!=null)){--i}var k=i;while((i>0)&&(j[i]==null)){--i}if(i<k){j.splice(i+1,k-i)}--i}}if(!c){var g=Math.abs(j[o+1].gr-j[d].gr)/e;var h=0;while(h<=o){var l=j[h++].gr;while((h<=o)&&(Math.abs(j[h+1].gr-l)<g)){j[h++]=null}}n()}if(c||((o-d)>1.5*e)){var m=Math.floor((o-d)/e);if(m<2){m=2}var h=d;while(++h<=o){for(var f=1;f<m;++f){if(++h<=o){j[h]=null}}}n()}};a.TH2Painter.prototype.CreateDrawBins=function(I,T,q,C){var m=this.GetSelectIndex("x","left",0);var l=this.GetSelectIndex("x","right",1);var S=this.GetSelectIndex("y","left",0);var P=this.GetSelectIndex("y","right",1);var p=this.GetItemName();if((p==null)||(p=="")){p=this.histo.fName}if(p.length>0){p+="\n"}var z=[],n=[];for(var Q=m;Q<=l;++Q){var H=this.GetBinX(Q);if(this.options.Logx&&(H<=0)){continue}z.push({indx:Q,axis:H,gr:this.grx(H),cnt:0})}for(var O=S;O<=P;++O){var G=this.GetBinY(O);if(this.options.Logy&&(G<=0)){continue}n.push({indx:O,axis:G,gr:this.gry(G),cnt:0})}this.maxbin=this.minbin=this.histo.getBinContent(m+1,S+1);var N=0,R=0,M=0,f,E,D;for(var Q=m;Q<l;++Q){for(var O=S;O<P;++O){R=this.histo.getBinContent(Q+1,O+1);if(R!=0){N++}if(R>this.maxbin){this.maxbin=R}else{if(R<this.minbin){this.minbin=R}}}}var g=1,k=1,v=false,A=0,e=1;if(q==1){if(this.options.Logz&&(this.maxbin>0)){v=true;e=Math.log(this.maxbin);A=(this.minbin>0)?Math.log(this.minbin):e-10;g=0.5/(e-A);k=0.5/(e-A)}else{g=0.5/(this.maxbin-this.minbin);k=0.5/(this.maxbin-this.minbin)}}if((this.options.Optimize>0)&&(N>1000)&&(q<2)){this.fContour=null;this.fUserContour=false;N=0;for(var Q=m;Q<l;++Q){for(var O=S;O<P;++O){R=this.histo.getBinContent(Q+1,O+1);if((R==0)||(R<this.minbin)){continue}var F=false;if(q==0){if(this.getValueColor(R)!=null){F=true}}else{f=v?(e-((R>0)?Math.log(R):A)):this.maxbin-R;E=f*g;D=f*k;if(((1-2*f*g)*(z[Q-m+1].gr-z[Q-m].gr)>0.05)||((1-2*f*k)*(n[O-S].gr-n[O-S+1].gr)>0.05)){F=true}}if(F){N++;z[Q-m].cnt+=1;n[O-S].cnt+=1}}}}if((this.options.Optimize>0)&&(N>1000)&&(q<2)){var L=40,K=40;var J=Math.abs(z[0].gr-z[z.length-1].gr)/Math.abs(n[0].gr-n[n.length-1].gr);if(J>1){K=Math.max(10,Math.round(L/J))}else{L=Math.max(10,Math.round(K*J))}if((this.options.Optimize>1)||(z.length>50)){this.CompressAxis(z,L,!this.options.Logx&&this.regularx)}if((this.options.Optimize>1)||(n.length>50)){this.CompressAxis(n,K,!this.options.Logy&&this.regulary)}}this.fContour=null;this.fUserContour=false;var t=[];for(var Q=0;Q<z.length-1;++Q){var u=z[Q].gr,s=z[Q+1].gr;for(var O=0;O<n.length-1;++O){var d=n[O].gr,c=n[O+1].gr;M=R=this.histo.getBinContent(z[Q].indx+1,n[O].indx+1);if((z[Q+1].indx>z[Q].indx+1)||(n[O+1].indx>n[O].indx+1)){M=0;for(var m=z[Q].indx;m<z[Q+1].indx;++m){for(var S=n[O].indx;S<n[O+1].indx;++S){var o=this.histo.getBinContent(m+1,S+1);R=Math.max(R,o);M+=o}}}if((R==0)||(R<this.minbin)){continue}var B=null;switch(q){case 0:var r=this.getValueColor(R);if(r!=null){B={x:u,y:c,width:s-u+1,height:d-c+1,stroke:"none",fill:r,tipcolor:(r=="black")?"grey":"black"}}break;case 1:f=v?(e-((R>0)?Math.log(R):A)):this.maxbin-R;E=f*g*(s-u);D=f*k*(d-c);B={x:u+E,y:c+D,width:s-u-2*E,height:d-c-2*D,stroke:this.attline.color,fill:this.fillcolor,tipcolor:this.fillcolor=="black"?"grey":"black"};if((B.width<0.05)||(B.height<0.05)){B=null}break;case 2:B={x:(z[Q].axis+z[Q+1].axis)/2,y:(n[O].axis+n[O+1].axis)/2,z:R};break}if(B==null){continue}if(C==1){if(this.x_kind=="labels"){B.tip=p+"x = "+this.AxisAsText("x",z[Q].axis)+"\n"}else{B.tip=p+"x = ["+this.AxisAsText("x",z[Q].axis)+", "+this.AxisAsText("x",z[Q+1].axis)+"]";if(z[Q].indx+1==z[Q+1].indx){B.tip+=" bin="+z[Q].indx+"\n"}else{B.tip+=" bins=["+z[Q].indx+","+(z[Q+1].indx-1)+"]\n"}}if(this.y_kind=="labels"){B.tip+="y = "+this.AxisAsText("y",n[O].axis)+"\n"}else{B.tip+="y = ["+this.AxisAsText("y",n[O].axis)+", "+this.AxisAsText("y",n[O+1].axis)+"]";if(n[O].indx+1==n[O+1].indx){B.tip+=" bin="+n[O].indx+"\n"}else{B.tip+=" bins=["+n[O].indx+","+(n[O+1].indx-1)+"]\n"}}if(M==R){B.tip+="entries = "+a.FFormat(M,a.gStyle.StatFormat)}else{B.tip+="sum = "+a.FFormat(M,a.gStyle.StatFormat)+" max = "+a.FFormat(R,a.gStyle.StatFormat)}}else{if(C==2){B.tip=p+"x = "+this.AxisAsText("x",z[Q].axis)+"\ny = "+this.AxisAsText("y",n[O].axis)+"\nentries = "+a.FFormat(M,a.gStyle.StatFormat)}}t.push(B)}}return t};a.TH2Painter.prototype.DrawSimpleCanvas=function(n,y){var u=this.GetSelectIndex("x","left",0);var t=this.GetSelectIndex("x","right",1);var e=this.GetSelectIndex("y","left",0);var d=this.GetSelectIndex("y","right",1);this.maxbin=this.minbin=this.histo.getBinContent(u+1,e+1);for(var x=u;x<t;++x){for(var v=e;v<d;++v){binz=this.histo.getBinContent(x+1,v+1);if(binz>this.maxbin){this.maxbin=binz}else{if(binz<this.minbin){this.minbin=binz}}}}var o=t-u,m=d-e;var l=this.draw_g.append("foreignObject").attr("width",n).attr("height",y);this.SetForeignObjectPosition(l,0,0);var g=l.append("xhtml:canvas").attr("width",o).attr("height",m).attr("style","width: "+n+"px; height: "+y+"px");var f=g.node().getContext("2d");var q=f.createImageData(o,m);var s=-1;for(var v=d-1;v>=e;v--){for(var x=u;x<t;++x){var r=this.histo.getBinContent(x+1,v+1);var k=r>this.minbin?this.getValueColor(r):"white";var z=b.rgb(k);q.data[++s]=z.r;q.data[++s]=z.g;q.data[++s]=z.b;q.data[++s]=255}}f.putImageData(q,0,0)};a.TH2Painter.prototype.DrawNormalCanvas=function(d,l){var k=this.CreateDrawBins(d,l,0,0);var j=this.draw_g.append("foreignObject").attr("width",d).attr("height",l);this.SetForeignObjectPosition(j,0,0);var e=j.append("xhtml:canvas").attr("width",d).attr("height",l);var c=e.node().getContext("2d");for(var g=0;g<k.length;++g){var f=k[g];c.fillStyle=f.fill;c.fillRect(f.x,f.y,f.width,f.height)}c.stroke()};a.TH2Painter.prototype.DrawBins=function(){this.RecreateDrawG(false,".main_layer",false);var e=this.frame_width(),i=this.frame_height();if((this.options.Color==2)&&!a.browser.isIE){return this.DrawSimpleCanvas(e,i)}if((this.options.Color==3)&&!a.browser.isIE){return this.DrawNormalCanvas(e,i)}var g=(this.options.Scat>0&&this.histo.fMarkerStyle>1);var j=(this.options.Color>0)||g;var c=0;if(a.gStyle.Tooltip){c=g?2:1}var f=this.CreateDrawBins(e,i,j?0:1,c);if(g){var d=a.Painter.createAttMarker(this.histo);var k=this.draw_g.selectAll(".marker").data(f).enter().append("svg:path").attr("class","marker").attr("transform",function(h){return"translate("+h.x.toFixed(1)+","+h.y.toFixed(1)+")"}).call(d.func);if(a.gStyle.Tooltip){k.append("svg:title").text(function(h){return h.tip})}}else{this.draw_g.selectAll(".bins").data(f).enter().append("svg:rect").attr("class","bins").attr("x",function(h){return h.x.toFixed(1)}).attr("y",function(h){return h.y.toFixed(1)}).attr("width",function(h){return h.width.toFixed(1)}).attr("height",function(h){return h.height.toFixed(1)}).style("stroke",function(h){return h.stroke}).style("fill",function(h){this["f0"]=h.fill;this["f1"]=h.tipcolor;return h.fill}).filter(function(){return a.gStyle.Tooltip?this:null}).on("mouseover",function(){if(a.gStyle.Tooltip){b.select(this).transition().duration(100).style("fill",this["f1"])}}).on("mouseout",function(){b.select(this).transition().duration(100).style("fill",this["f0"])}).append("svg:title").text(function(h){return h.tip})}delete f};a.TH2Painter.prototype.CanZoomIn=function(e,d,c){if((e=="x")&&(this.GetIndexX(c,0.5)-this.GetIndexX(d,0)>1)){return true}if((e=="y")&&(this.GetIndexY(c,0.5)-this.GetIndexY(d,0)>1)){return true}if(e=="z"){return true}return false};a.TH2Painter.prototype.Draw2D=function(){if(this.options.Lego>0){this.options.Lego=0}if(this["done2d"]){return}if((this.FindPalette()==null)&&this.create_canvas&&(this.options.Zscale>0)){var c=this.CreatePalette(0.04);this.svg_frame().property("frame_painter").Shrink(0,c);this.svg_frame().property("frame_painter").Redraw();this.CreateXY()}else{if(this.options.Zscale==0){this.FindPalette(true)}}if(a.gStyle.AutoStat&&this.create_canvas){this.CreateStat()}this.DrawAxes();this.DrawGrids();this.DrawBins();if(this.create_canvas){this.DrawTitle()}this.DrawNextFunction(0,function(){this.AddInteractive();if(this.options.AutoZoom){this.AutoZoom()}this["done2d"]=true;this.DrawingReady()}.bind(this));return this};a.TH2Painter.prototype.Draw3D=function(d){if(this.options.Lego<=0){this.options.Lego=1}var c=this;a.AssertPrerequisites("3d",function(){a.Painter.real_drawHistogram2D(c,d);c.DrawingReady()});return c};a.Painter.drawHistogram2D=function(e,c,d){a.extend(this,new a.TH2Painter(c));this.SetDivId(e,1);this.options=this.DecodeOptions(d);this.CheckPadOptions();this.ScanContent();this.CreateXY();if(this.options.Lego>0){return this.Draw3D(d)}return this.Draw2D()};return a.Painter}));